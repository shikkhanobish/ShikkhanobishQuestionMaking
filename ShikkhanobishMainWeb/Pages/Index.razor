@using ShikkhanobishMainWeb.Models
@using Flurl.Http
@using System.Globalization
@inject IJSRuntime jsRuntime

@using Microsoft.AspNetCore.Components;
@page "/{tID}"

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>MakeQuestion</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="Responsive bootstrap 4 admin template" name="description" />
    <meta content="Coderthemes" name="author" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link href="~/css/makeQues.css" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
</head>

<body style="background-color:white">

    <!-- Begin page -->
    <!-- Start Page Content here -->
    <!-- ============================================================== -->


    
    <div class="content">

        <!-- Start container-fluid -->
        <div class="container-fluid">
            <!--row-->

            <div class="form-group row justify-content-center">

                <div class="col-3">
                    <div class="card-box widget-inline " style="background-color: #EADFFF;">
                        <div class="text-center p-2">
                            <h2 class="" style="color: #46189F"> <b>@countTQH</b></h2>
                            <p class="" style="color:rebeccapurple">
                                Total Uploaded

                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card-box widget-inline " style="background-color: #D2FFE9;">
                        <div class="text-center p-2">
                            <h2 class="" style="color: #10884E"> <b>@tap</b></h2>
                            <p class="" style="color: #10884E">
                                Total Approved

                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card-box widget-inline " style="background-color: #FFCECE;">
                        <div class="text-center p-2">
                            <h2 class="" style="color: #931919"> <b>@tde</b></h2>
                            <p class="" style="color: #931919">
                                Total Declined

                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card-box widget-inline " style="background-color: #EEEEEE;">
                        <div class="text-center p-2">
                            <h2 class="" style="color: #646464"> <b>@tpe</b></h2>
                            <p class="" style="color: #646464">
                                Total Pending

                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <!--end row -->

        </div>
        <br />
        <div style="text-align:center">
            <h3 style="color: #8F2EE3; ">@tName</h3>
        </div>
        <div class="col-12 " style="text-align:right">

            <a href="@($"MakeQuestion/{tID}")" class="btn btn-outline-info">
                <span> Make Question </span>
            </a>
        </div>

        <br />

        <div class="row">

            <div class="col-md-12">

                <br />
                <br />
                <br />

                <div class="card">
                    <div class="card-body">
                        <label style="color:blueviolet;font-size:30px;" class="card-title">Task  History</label>
                        <div class="table-responsive">
                            <table id="" class="table table-bordered" style="text-align:center; ">
                                <thead style="color: black; font-weight: bold;font-size:10px;">
                                    <tr>
                                        <th>Task Number</th>
                                        <th>Assigned Number</th>
                                        <th>Chapter ID</th>
                                        <th>Chapter Name</th>
                                        <th>Task Date</th>
                                        <th>Assign Time (DD/MM/YYYY)</th>
                                        <th>Submitted</th>
                                        <th>Remaining</th>
                                        <th>IS Task Submitted</th>
                                        <th>Status</th>

                                    </tr>
                                </thead>
                                <tbody style="font-size: 10px; ">
                                    @foreach (var item in LiveshowInfo)
                                    {
                                    <tr>
                                        <td style="color: #2E2E2E">@item.index</td>
                                        <td style="color: #2E2E2E">@item.MCQNumbers</td>
                                        <td style="color: #2E2E2E">@item.chapterID</td>
                                        <td style="color: #2E2E2E">@item.chapterName</td>
                                        <td style="color: #2E2E2E">@item.date</td>
                                        <td style="color: #2E2E2E">@item.startTime</td>

                                        <td style="color: green">@item.submitted</td>
                                        <td style="color: red">@item.reMain</td>
                                        <td style="color: @item.isTaskSubColor; font-weight: bold">
                                            <i class="fas fa-times" style="display:@item.isTaskSubNootDone"></i>
                                            <i class="fas fa-check-double" style="display:@item.isTaskSubDone"></i>
                                            <i style="display:@item.isTaskSubPending">---</i>
                                        </td>
                                        <td style="color: @item.statusColor; font-weight: bold">@item.status</td>



                                    </tr>

                                    }

                                </tbody>


                            </table>
                        </div>

                        <div class="form-group row">
                            <div class="col-3">
                                <select class="form-control btn btn-purple" style="" id="class" @onchange="selectFileLink">
                                    <option class="">Select Task Number</option>
                                    @foreach (var item in LiveshowInfo)
                                    {
                                        <option value="@item.FileLink">@item.index -> <a style="color: @item.statusColor; font-weight: bold"> @item.status</a></option>
                                    }
                                </select>
                            </div>
                            <div class="col-3">
                                <a href="@url" target="_blank" style="color: @linkTxtColor"> Open PDF Link</a>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
                
                

                <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: @prgsValue; display:@showprgs" aria-valuenow="@prgsValue" aria-valuemin="0" aria-valuemax="100">Loading... @prgsValue</div>
                </div>
                <div class="card-header " style="text-align:center">
                    <h5>Question History</h5>
                </div>
                @foreach (var qs in showQSList)
                {
                    <div class="form-group row">

                        <div class="col-12">

                            <div class="form-group row">

                                <div class="col-12">

                                    <div>
                                        <div class="col-2">
                                            <label class="" style=" border-radius: 10px; border: 1px solid @qs.reviewColor; padding: 3px 12px; color:@qs.reviewColor;">@qs.reviewName</label>
                                            &nbsp;&nbsp; <label style="font-size: 10px">@qs.publishingDate</label>
                                        </div>
                                        <span style="font-size:14px;color:grey; font-weight:bold">@qs.index</span><span>.</span>
                                        <span style="font-size:14px;font-weight:bold; color:black;">@qs.mainQuestion</span>
                                        <br />
                                        <br />
                                        <div>
                                            &nbsp;&nbsp;<span style="font-size:14px;color:blueviolet; ">A</span><span>.</span>&nbsp;&nbsp;<label style="font-size: 13px; color: @qs.op1BackColor;">@qs.option1</label>

                                        </div>
                                        <div>
                                            &nbsp;&nbsp;<span style="font-size: 14px; color: blueviolet; ">B</span><span>.</span>&nbsp;&nbsp;<label style="font-size: 13px; color: @qs.op2BackColor;">@qs.option2</label>

                                        </div>
                                        <div>
                                            &nbsp;&nbsp;<span style="font-size: 14px; color: blueviolet; ">C</span><span>.</span>&nbsp;&nbsp;<label style="font-size: 13px; color: @qs.op3BackColor;">@qs.option3</label>

                                        </div>
                                        <div>

                                            &nbsp;&nbsp;<span style="font-size: 14px; color: blueviolet;">D</span><span>.</span>&nbsp;&nbsp;<label style="font-size: 13px; color: @qs.op4BackColor;">@qs.option4</label>

                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                }




            </div>
        </div>
        <br />
        <br />
        <br />
        <!-- end container-fluid -->
        <!-- Footer Start -->
        <footer class="footer">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-12">
                        2021 &copy; shikkhanobish
                    </div>
                </div>
            </div>
        </footer>
        <!-- end Footer -->
    </div>
    <!-- end content -->
    <!-- END wrapper -->
    <!-- Vendor js -->

</body>
</html>

@code{
    [Parameter]
    public string tID { get; set; }
    public int tup, tap, tde, tpe;

    public string tName { get; set; }
    string url { get; set; }
    int countTQH;
    string linkTxtColor { get; set; }
    List<TeacherQuesHistory> tqhList = new List<TeacherQuesHistory>();
    List<Question> questionList = new List<Question>();
    List<Question> showQSList = new List<Question>();
    List<Teacher> teacherList = new List<Teacher>();
    List<ClassInfo> allClassList = new List<ClassInfo>();
    List<Subject> allSubject = new List<Subject>();
    List<Chapter> allChapter = new List<Chapter>();
    string prgsValue { get; set; }
    string showprgs { get; set; }
    List<Chapter> allc = new List<Chapter>();
    List<Subject> allsub = new List<Subject>();
    List<ClassInfo> allClass = new List<ClassInfo>();
    List<Teacher> teacherListN = new List<Teacher>();
    List<TeacherQuesHistory> thList = new List<TeacherQuesHistory>();
    List<dataentryOperatorTask> LiveshowInfo = new List<dataentryOperatorTask>();
    List<Question> quesList = new List<Question>();
    string selectedColorone = "";
    string selectedColortwo = "";
    string selectedColorthree = "";
    string selectedColorfour = "";
    string thisLink;
    List<dataentryOperatorTask> operatorList = new List<dataentryOperatorTask>();
    int reload = 0;
    protected override async Task OnInitializedAsync()
    {
        linkTxtColor = "Gray;";
        showprgs = "Block";
        StateHasChanged();
        prgsValue = "10%";
        await getAllInfo();
        StateHasChanged();
        prgsValue = "20%";
        await GetTeacherQuestionHistory();
        StateHasChanged();
        prgsValue = "40%";
        await GetHistoryCount();
        prgsValue = "50%";
        StateHasChanged();
        await GetTeacherWithID();
        prgsValue = "80%";
        StateHasChanged();
        await GetTask();
        prgsValue = "100%";
        showprgs = "None";
        StateHasChanged();
    }

    public async Task goLink()

    {
        //string url = thisLink;

    }
    private void selectFileLink(ChangeEventArgs task)
    {
        if(task.Value.ToString()[0] == 'S')
        {
            linkTxtColor = "Gray";
            url = "";
        }
        else
        {
            linkTxtColor = "Blue";
            url = task.Value.ToString();
        }


    }
    public async Task getAllInfo()
    {
        allc = await "https://api.shikkhanobish.com/api/ShikkhanobishLogin/getChapter".GetJsonAsync<List<Chapter>>();
        allsub = await "https://api.shikkhanobish.com/api/ShikkhanobishLogin/getSubject".GetJsonAsync<List<Subject>>();
        allClass = await "https://api.shikkhanobish.com/api/ShikkhanobishLogin/getClassInfo".GetJsonAsync<List<ClassInfo>>();
        operatorList = await "https://api.shikkhanobish.com/api/ShikkhanobishTeacher/getdataentryOperatorTask".PostJsonAsync(new { }).ReceiveJson<List<dataentryOperatorTask>>();
        teacherListN = await "https://api.shikkhanobish.com/api/ShikkhanobishTeacher/getAllTeacher".PostJsonAsync(new { }).ReceiveJson<List<Teacher>>();
        thList = await "https://api.shikkhanobish.com/api/ShikkhanobishLogin/getTeacherQuestionHistory".GetJsonAsync<List<TeacherQuesHistory>>();
        quesList = await "https://api.shikkhanobish.com/api/ShikkhanobishLogin/getQuestion".GetJsonAsync<List<Question>>();
    }
    public async Task GetTask()
    {


        List<dataentryOperatorTask> thisOpList = new List<dataentryOperatorTask>();
        List<dataentryOperatorTask> LivethisOpList = new List<dataentryOperatorTask>();
        foreach (var teacher in teacherListN)
        {
            if (teacher.teacherID == int.Parse(tID))
            {
                tName = teacher.name;
                break;
            }
        }

        CultureInfo culturen = new CultureInfo("en-US");
        thisOpList = operatorList;
        List<string> activeTaskList = new List<string>();
        List<int> doneOP = new List<int>();
        List<dataentryOperatorTask> thisopTask = new List<dataentryOperatorTask>();
        for (int i = 0; i < thisOpList.Count; i++)
        {
            thisOpList[i] = operatorList[i];
            for (int z = 0; z < teacherList.Count; z++)
            {
                if (thisOpList[i].userID == teacherList[z].teacherID)
                {
                    thisOpList[i].userName = teacherList[z].name;
                    break;
                }
            }
            for (int e = 0; e < allc.Count; e++)
            {
                if (allc[e].chapterID == thisOpList[i].chapterID)
                {
                    thisOpList[i].chapterName = allc[e].name;
                    break;
                }
            }
            //indivisual TAsk
            thisopTask = new List<dataentryOperatorTask>();
            bool shouldCheck = true;
            for (int j = 0; j < doneOP.Count; j++)
            {
                if (doneOP[j] == thisOpList[i].userID)
                {
                    shouldCheck = false;
                }
            }

            if (shouldCheck)
            {
                if(thisOpList[i].userID == int.Parse(tID))
                {
                    doneOP.Add(thisOpList[i].userID);
                    for (int k = 0; k < thisOpList.Count; k++)
                    {
                        if (thisOpList[i].userID == thisOpList[k].userID)
                        {
                            thisopTask.Add(thisOpList[k]);
                        }
                    }
                    ////// submit count
                    List<dataentryOperatorTask> SortedListN = new List<dataentryOperatorTask>();
                    SortedListN = thisopTask.OrderBy(x => x.startTime).ToList();
                    thisopTask = SortedListN;
                    int submitted = 0;
                    for (int k = 0; k < thisopTask.Count; k++)
                    {
                        for (int j = 0; j < thList.Count; j++)
                        {
                            if (thisopTask[k].userID == thList[j].teacherID)
                            {
                                CultureInfo culture = new CultureInfo("en-US");
                                DateTime HistoryDateFormat = DateTime.ParseExact(thList[j].review, "dd'-'MM'-'yyyy' 'HH':'mm':'ss", culture);
                                DateTime TaskDateFormatSt = DateTime.ParseExact(thisopTask[k].startTime, "MM/dd/yyyy hh:mm tt", culture);
                                DateTime TaskDateFormatEnd = new DateTime();
                                if (k == thisopTask.Count - 1)
                                {
                                    TaskDateFormatEnd = DateTime.Now;
                                }
                                else
                                {
                                    TaskDateFormatEnd = DateTime.ParseExact(thisopTask[k + 1].startTime, "MM/dd/yyyy hh:mm tt", culture);
                                }

                                if (TaskDateFormatSt < HistoryDateFormat && TaskDateFormatEnd > HistoryDateFormat)
                                {
                                    thisopTask[k].submitted++;
                                }
                            }

                        }
                        for (int l = 0; l < thisOpList.Count; l++)
                        {
                            if (thisOpList[l].taskID == thisopTask[k].taskID)
                            {
                                thisOpList[l].submitted = thisopTask[k].submitted;
                            }
                        }

                    }


                    ////// Active Define
                    var lastActive = DateTime.ParseExact(thisopTask[0].startTime, "MM/dd/yyyy hh:mm tt", culturen);
                    int indexID = 0;
                    for (int l = 0; l < thisopTask.Count; l++)
                    {
                        var thisDatetime = DateTime.ParseExact(thisopTask[l].startTime, "MM/dd/yyyy hh:mm tt", culturen);
                        if (lastActive < thisDatetime)
                        {
                            indexID = l;
                            lastActive = thisDatetime;
                        }
                    }
                    activeTaskList.Add(thisopTask[indexID].taskID);
                }

            }

        }
        for (int i = 0; i < thisOpList.Count; i++)
        {
            if(thisOpList[i].userID == int.Parse(tID))
            {
                string link = "";
                string cleanMCQNumber = "";
                bool now = false;
                bool cleanNow = false;
                foreach (var ch in thisOpList[i].MCQNumbers)
                {

                    if (now)
                    {
                        link += ch;
                    }
                    if (ch == '#')
                    {
                        now = true;
                    }
                    if (ch == 'L')
                    {
                        cleanNow = true;
                    }
                    if (!cleanNow)
                    {
                        cleanMCQNumber += ch;
                    }

                }
                thisOpList[i].FileLink = link;
                thisOpList[i].MCQNumbers = cleanMCQNumber;
                if (thisOpList[i].reMain < 0)
                {
                    thisOpList[i].reMain = 0;
                }
                thisOpList[i].statusColor = "#979797";
                if (thisOpList[i].submitted >= 100)
                {
                    thisOpList[i].isTaskSubDone = "Block";
                    thisOpList[i].isTaskSubPending = "None";
                    thisOpList[i].isTaskSubNootDone = "None";
                    thisOpList[i].isTaskSubColor = "#08B483";
                }
                else
                {
                    thisOpList[i].isTaskSubNootDone = "Block";
                    thisOpList[i].isTaskSubDone = "None";
                    thisOpList[i].isTaskSubPending = "None";
                    thisOpList[i].isTaskSubColor = "#CE0C0C";
                }
                thisOpList[i].status = "Inactive";
                ////
                for (int j = 0; j < activeTaskList.Count; j++)
                {
                    if (activeTaskList[j] == thisOpList[i].taskID)
                    {
                        thisOpList[i].statusColor = "#541BD7";
                        thisOpList[i].isTaskSubPending = "Block";
                        thisOpList[i].isTaskSubDone = "None";
                        thisOpList[i].isTaskSubNootDone = "None";
                        thisOpList[i].isTaskSubColor = "#BFB10C";
                        thisOpList[i].status = "Active";
                    }
                }
                ///
                var nt = DateTime.ParseExact(thisOpList[i].startTime, "MM/dd/yyyy hh:mm tt", culturen);
                thisOpList[i].startTime = nt.ToString("dd/MM/yyyy hh:mm tt");
                nt = DateTime.ParseExact(thisOpList[i].endTime, "MM/dd/yyyy hh:mm tt", culturen);
                thisOpList[i].endTime = nt.ToString("dd/MM/yyyy hh:mm tt");

            }

        }
        List<dataentryOperatorTask> shownow = new List<dataentryOperatorTask>();
        int taskindex = 0;
        for(int u = 0; u < thisOpList.Count; u++)
        {
            if(thisOpList[u].userID == int.Parse(tID))
            {
                taskindex++;
                thisOpList[u].index = taskindex;
                shownow.Add(thisOpList[u]);
            }
        }
        List<dataentryOperatorTask> SortedList = new List<dataentryOperatorTask>();
        SortedList = shownow.OrderBy(x => x.startTime).ToList();
        SortedList.Reverse();
        shownow = SortedList;

        LiveshowInfo = shownow;








    }
    public async Task GetTeacherQuestionHistory()
    {
        var thl = thList;

        for (int i = 0; i < thl.Count; i++)
        {
            if (thl[i].teacherID.ToString() == tID)
            {
                tqhList.Add(thl[i]);
            }
        }
        List<TeacherQuesHistory> SortedList = new List<TeacherQuesHistory>();
        SortedList = tqhList.OrderBy(x => x.review).ToList();
        SortedList.Reverse();
        tqhList.Clear();
        tqhList = SortedList;
        List<Question> thisqsList = new List<Question>();
        List<Question> ques = await "https://api.shikkhanobish.com/api/ShikkhanobishLogin/getQuestion".GetJsonAsync<List<Question>>();
        int indexCount = 1;
        for (int i = 0; i < ques.Count; i++)
        {
            for (int j = 0; j < tqhList.Count; j++)
            {
                if (tqhList[j].questionID == ques[i].questionID)
                {
                    Question thisQs = new Question();
                    thisQs = ques[i];
                    thisQs.index = indexCount;
                    thisQs.publishingDate = tqhList[j].review;
                    thisQs.op1BackColor = "Gray";
                    thisQs.op2BackColor = "Gray";
                    thisQs.op3BackColor = "Gray";
                    thisQs.op4BackColor = "Gray";

                    if (thisQs.rightAnswer == 1)
                    {
                        thisQs.op1BackColor = "Green";
                    }
                    if (thisQs.rightAnswer == 2)
                    {
                        thisQs.op2BackColor = "Green";
                    }
                    if (thisQs.rightAnswer == 3)
                    {
                        thisQs.op3BackColor = "Green";
                    }
                    if (thisQs.rightAnswer == 4)
                    {
                        thisQs.op4BackColor = "Green";
                    }
                    if (thisQs.review == 0)
                    {
                        thisQs.reviewName = "Pending";
                        thisQs.reviewColor = "Gray";
                    }
                    if (thisQs.review == 1)
                    {
                        thisQs.reviewName = "Approved";
                        thisQs.reviewColor = "Green";
                    }
                    if (thisQs.review == 2)
                    {
                        thisQs.reviewName = "Not Approved";
                        thisQs.reviewColor = "Red";
                    }
                    thisqsList.Add(thisQs);
                    indexCount++;
                }
            }
        }
        List<Question> SortedListNew = new List<Question>();
        SortedListNew = thisqsList.OrderBy(x => x.index).ToList();
        SortedListNew.Reverse();
        thisqsList.Clear();
        thisqsList = SortedListNew;
        showQSList = thisqsList;
    }

    public async Task GetHistoryCount()
    {

        int count = 0;
        var list = await "https://api.shikkhanobish.com/api/ShikkhanobishLogin/getTeacherQuestionHistory".GetJsonAsync<List<TeacherQuesHistory>>();
        for (int i = 0; i < list.Count; i++)
        {
            if (tID == list[i].teacherID.ToString())
            {
                count++;
                foreach (var qs in quesList)
                {
                    if (qs.questionID == list[i].questionID)
                    {
                        if (qs.review == 0)
                        {
                            tpe++;
                        }
                        if (qs.review == 1)
                        {
                            tap++;
                        }
                        if (qs.review == 2)
                        {
                            tde++;
                        }
                    }
                }

            }
            countTQH = count;
        }
    }



    public async Task GetClassSubChap()
    {


        allClassList = await "https://api.shikkhanobish.com/api/ShikkhanobishLogin/getClassInfo".GetJsonAsync<List<ClassInfo>>();
        allSubject = await "https://api.shikkhanobish.com/api/ShikkhanobishLogin/getSubject".GetJsonAsync<List<Subject>>();
        allChapter = await "https://api.shikkhanobish.com/api/ShikkhanobishLogin/getChapter".GetJsonAsync<List<Chapter>>();


    }



    public async Task GetTeacherWithID()
    {
        var list = teacherListN;
        for (int i = 0; i < list.Count; i++)
        {
            if (tID == list[i].teacherID.ToString())
            {
                tName = list[i].name;
            }
        }
    }





    //90843385




}

